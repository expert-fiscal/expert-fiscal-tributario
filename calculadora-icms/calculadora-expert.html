<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Tributos NFe v2 - Reforma Tributária</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>

    <style>
        body {
            background-color: #e9ecef;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .calculator-container {
            max-width: 600px;
            margin: 2rem auto;
            border: 1px solid #ccc;
            border-radius: 20px;
            background: #2d3436;
            box-shadow: 0 10px 20px rgba(0,0,0,0.19), 0 6px 6px rgba(0,0,0,0.23);
            padding: 25px;
            color: #dfe6e9;
        }
        .calculator-display {
            background-color: #b2bec3;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: right;
            font-family: 'Courier New', Courier, monospace;
            border: 3px solid #636e72;
        }
        .calculator-display h4, .calculator-display h2 {
            margin: 0;
            color: #2d3436;
            font-weight: bold;
        }
        .calculator-display .tax-item {
            font-size: 1rem;
            display: flex;
            justify-content: space-between;
        }
        .form-check-label {
            cursor: pointer;
        }
        #calculateBtn {
            background-color: #fdcb6e;
            border: none;
            color: #2d3436;
            font-weight: bold;
            transition: background-color 0.2s ease-in-out;
        }
        #calculateBtn:hover {
            background-color: #ffeaa7;
        }
        #graficos {
            padding-top: 2rem;
            padding-bottom: 2rem;
        }
    </style>
</head>
<body>

    <div class="container my-4">
        <h1 class="text-center mb-4">Calculadora de Tributos da NFe</h1>

        <section id="calculadora">
            <div class="calculator-container">
                <div class="calculator-display">
                    <div id="display-standard">
                        <div class="tax-item"><span>ICMS:</span> <span id="display_icms">R$ 0,00</span></div>
                        <div class="tax-item"><span>PIS:</span> <span id="display_pis">R$ 0,00</span></div>
                        <div class="tax-item"><span>COFINS:</span> <span id="display_cofins">R$ 0,00</span></div>
                        <div class="tax-item"><span>IPI:</span> <span id="display_ipi">R$ 0,00</span></div>
                    </div>
                    <div id="display-reform" class="d-none">
                        <div class="tax-item"><span>CBS (Federal):</span> <span id="display_cbs">R$ 0,00</span></div>
                        <div class="tax-item"><span>IBS (Estadual/Mun.):</span> <span id="display_ibs">R$ 0,00</span></div>
                    </div>
                    <hr class="my-2 border-dark">
                    <h4>Total Tributos: <span id="display_total_tributos">R$ 0,00</span></h4>
                    <h2 class="mt-1">Total NFe: <span id="display_total_nfe">R$ 0,00</span></h2>
                </div>

                <div class="controls">
                    <div class="mb-3">
                        <label for="valorProdutos" class="form-label">Valor Total dos Produtos (R$)</label>
                        <input type="number" class="form-control" id="valorProdutos" placeholder="Ex: 1000.00" step="0.01">
                    </div>
                    <fieldset class="mb-3">
                        <legend class="fs-6">Selecione o(s) Regime(s) de Tributação</legend>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" id="regimeAtual" value="atual" checked>
                            <label class="form-check-label" for="regimeAtual">
                                Tributos Atuais
                            </label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" id="regimeReforma" value="reforma">
                            <label class="form-check-label" for="regimeReforma">
                                Reforma Tributária (IBS/CBS)
                            </label>
                        </div>
                    </fieldset>
                    <button id="calculateBtn" class="btn btn-lg w-100 mt-2">Calcular</button>
                </div>
            </div>
        </section>

        <hr class="my-5">

        <section id="graficos" class="d-none">
            <h2 class="text-center mb-4">Composição dos Tributos</h2>
            <div class="row">
                <div class="col-lg-6 mb-4 mb-lg-0">
                    <h4 class="text-center">Composição Percentual (%) sobre o Total da NFe</h4>
                    <canvas id="percentageChart"></canvas>
                </div>
                <div class="col-lg-6">
                    <h4 class="text-center">Composição em Valor Monetário (R$)</h4>
                    <canvas id="valueChart"></canvas>
                </div>
            </div>
        </section>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Registrar o plugin de datalabels globalmente
            Chart.register(ChartDataLabels);

            // --- ELEMENTOS DO DOM ---
            const valorProdutosInput = document.getElementById('valorProdutos');
            const calculateBtn = document.getElementById('calculateBtn');
            const regimeAtualCheck = document.getElementById('regimeAtual');
            const regimeReformaCheck = document.getElementById('regimeReforma');
            
            // Displays de valores
            const displays = {
                icms: document.getElementById('display_icms'),
                pis: document.getElementById('display_pis'),
                cofins: document.getElementById('display_cofins'),
                ipi: document.getElementById('display_ipi'),
                cbs: document.getElementById('display_cbs'),
                ibs: document.getElementById('display_ibs'),
                totalTributos: document.getElementById('display_total_tributos'),
                totalNFe: document.getElementById('display_total_nfe'),
                standardGroup: document.getElementById('display-standard'),
                reformGroup: document.getElementById('display-reform')
            };
            
            const graficosSection = document.getElementById('graficos');

            // --- ALÍQUOTAS (Valores didáticos e simplificados) ---
            const aliquotas = {
                atuais: { icms: 0.18, pis: 0.0165, cofins: 0.076, ipi: 0.05 },
                reforma: { cbs: 0.088, ibs: 0.177 }
            };

            // --- INSTÂNCIAS DOS GRÁFICOS ---
            let percentageChartInstance = null;
            let valueChartInstance = null;
            const percentageChartCtx = document.getElementById('percentageChart').getContext('2d');
            const valueChartCtx = document.getElementById('valueChart').getContext('2d');
            
            // --- FUNÇÕES ---

            const formatCurrency = (value) => value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

            /**
             * Alterna a visibilidade dos displays de tributos com base nos checkboxes.
             */
            const toggleDisplay = () => {
                displays.standardGroup.classList.toggle('d-none', !regimeAtualCheck.checked);
                displays.reformGroup.classList.toggle('d-none', !regimeReformaCheck.checked);
            };
            
            /**
             * Reseta todos os campos do display para R$ 0,00.
             */
            const resetDisplayFields = () => {
                for (const key in displays) {
                    if (displays[key].tagName === 'SPAN') {
                        displays[key].textContent = formatCurrency(0);
                    }
                }
            };
            
            /**
             * Cria ou atualiza um gráfico Chart.js.
             */
            const createOrUpdateChart = (instance, context, chartType, labels, data, title) => {
                if (instance) {
                    instance.destroy();
                }
                
                const backgroundColors = [
                    'rgba(255, 99, 132, 0.8)', 'rgba(54, 162, 235, 0.8)',
                    'rgba(255, 206, 86, 0.8)', 'rgba(75, 192, 192, 0.8)',
                    'rgba(153, 102, 255, 0.8)', 'rgba(255, 159, 64, 0.8)'
                ];
                
                return new Chart(context, {
                    type: chartType,
                    data: {
                        labels: labels,
                        datasets: [{
                            label: title,
                            data: data,
                            backgroundColor: backgroundColors.slice(0, data.length),
                        }]
                    },
                    options: {
                        indexAxis: chartType === 'bar' ? 'y' : 'x',
                        scales: chartType === 'bar' ? {
                            x: { beginAtZero: true }
                        } : {},
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: (context) => {
                                        let label = context.label || '';
                                        if (label) { label += ': '; }
                                        if (context.parsed.x !== null || context.parsed !== null) {
                                            const value = chartType === 'bar' ? context.parsed.x : context.parsed;
                                            label += chartType === 'doughnut' ? value.toFixed(2) + '%' : formatCurrency(value);
                                        }
                                        return label;
                                    }
                                }
                            },
                            datalabels: {
                                color: '#fff',
                                anchor: 'end',
                                align: 'start',
                                offset: chartType === 'bar' ? 10 : 0,
                                font: {
                                    weight: 'bold'
                                },
                                formatter: (value) => {
                                    if (value === 0) return '';
                                    return chartType === 'doughnut' ? value.toFixed(1) + '%' : formatCurrency(value);
                                }
                            }
                        }
                    }
                });
            };

            /**
             * Função principal que calcula os tributos.
             */
            const calcularTributos = () => {
                const valorProdutos = parseFloat(valorProdutosInput.value) || 0;
                
                if (valorProdutos <= 0) {
                    alert('Por favor, insira um valor de produtos válido.');
                    return;
                }
                
                if (!regimeAtualCheck.checked && !regimeReformaCheck.checked) {
                    alert('Selecione ao menos um regime de tributação para calcular.');
                    return;
                }

                resetDisplayFields();

                let totalTributos = 0;
                let chartLabels = [];
                let chartValues = [];
                
                // Calcula tributos atuais se selecionado
                if (regimeAtualCheck.checked) {
                    const icms = valorProdutos * aliquotas.atuais.icms;
                    const pis = valorProdutos * aliquotas.atuais.pis;
                    const cofins = valorProdutos * aliquotas.atuais.cofins;
                    const ipi = valorProdutos * aliquotas.atuais.ipi;
                    
                    totalTributos += icms + pis + cofins + ipi;
                    
                    displays.icms.textContent = formatCurrency(icms);
                    displays.pis.textContent = formatCurrency(pis);
                    displays.cofins.textContent = formatCurrency(cofins);
                    displays.ipi.textContent = formatCurrency(ipi);

                    chartLabels.push('ICMS', 'PIS', 'COFINS', 'IPI');
                    chartValues.push(icms, pis, cofins, ipi);
                }

                // Calcula tributos da reforma se selecionado
                if (regimeReformaCheck.checked) {
                    const cbs = valorProdutos * aliquotas.reforma.cbs;
                    const ibs = valorProdutos * aliquotas.reforma.ibs;
                    
                    totalTributos += cbs + ibs;

                    displays.cbs.textContent = formatCurrency(cbs);
                    displays.ibs.textContent = formatCurrency(ibs);
                    
                    chartLabels.push('CBS', 'IBS');
                    chartValues.push(cbs, ibs);
                }

                const totalNFe = valorProdutos + totalTributos;

                // Atualiza totais
                displays.totalTributos.textContent = formatCurrency(totalTributos);
                displays.totalNFe.textContent = formatCurrency(totalNFe);
                
                // Prepara dados para os gráficos
                const chartPercentages = chartValues.map(tax => (tax / totalNFe) * 100);

                // Atualiza os gráficos
                graficosSection.classList.remove('d-none');
                percentageChartInstance = createOrUpdateChart(percentageChartInstance, percentageChartCtx, 'doughnut', chartLabels, chartPercentages, '% do Total da NFe');
                valueChartInstance = createOrUpdateChart(valueChartInstance, valueChartCtx, 'bar', chartLabels, chartValues, 'Valor (R$)');
            };

            // --- EVENT LISTENERS ---
            calculateBtn.addEventListener('click', calcularTributos);
            regimeAtualCheck.addEventListener('change', toggleDisplay);
            regimeReformaCheck.addEventListener('change', toggleDisplay);

            // Inicia o display correto
            toggleDisplay();
        });
    </script>
</body>
</html>